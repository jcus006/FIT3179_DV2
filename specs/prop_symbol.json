{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": "container",
  "height": 650,
  "autosize": { "type": "fit", "contains": "padding" },
  "projection": { "type": "mercator", "center": [134, -28], "scale": 850 },

  "params": [
    {
      "name": "season_filter",
      "value": "Winter",
      "bind": {
        "input": "select",
        "options": ["Summer", "Autumn", "Winter", "Spring"],
        "labels": ["Summer", "Autumn", "Winter", "Spring"],
        "name": "Season: "
      }
    },
    {
      "name": "year_filter",
      "value": 2009,
      "bind": {
        "input": "range",
        "min": 2009,
        "max": 2016,
        "step": 1,
        "name": "Year:\t"
      }
    },
    {
      "name": "attribute_select",
      "value": "MaxTemp",
      "bind": {
        "input": "select",
        "options": [
          "MaxTemp",
          "MinTemp",
          "Rainfall",
          "Sunshine",
          "WindGustSpeed"
        ],
        "labels": [
          "Maximum Temp",
          "Minimum Temp",
          "Rainfall",
          "Sunshine",
          "Wind Gust Speed"
        ],
        "name": "Attribute: "
      }
    },
    {
      "name": "legendTitles",
      "value": {
        "MaxTemp": "Maximum Temperature (°C)",
        "MinTemp": "Minimum Temperature (°C)",
        "Rainfall": "Rainfall (mm)",
        "Sunshine": "Sunshine (hours)",
        "WindGustSpeed": "Wind Gust Speed (km/h)"
      }
    },
    {
      "name": "attributeColors",
      "value": {
        "MaxTemp": "red",
        "MinTemp": "orange",
        "Rainfall": "blue",
        "Sunshine": "gold",
        "WindGustSpeed": "gray"
      }
    },
    {
      "name": "attributeColorSchemes",
      "value": {
        "MaxTemp": "reds",
        "MinTemp": "oranges",
        "Rainfall": "blues",
        "Sunshine": "reds",
        "WindGustSpeed": "purples"
      }
    }
  ],

  "layer": [
    {
      "data": { "sphere": true },
      "mark": { "type": "geoshape", "fill": "#eaf4ff" }
    },

    {
      "data": { "graticule": { "step": [20, 20] } },
      "mark": {
        "type": "geoshape",
        "stroke": "#cbd5e1",
        "strokeWidth": 0.5,
        "fill": null
      }
    },
    {
      "data": {
        "url": "maps/ne_50m_admin_0_countries.json",
        "format": { "type": "topojson", "feature": "ne_50m_admin_0_countries" }
      },
      "mark": {
        "type": "geoshape",
        "fill": "#f3f4f6",
        "stroke": "#94a3b8",
        "strokeWidth": 0.5
      }
    },
    {
      "data": {
        "url": "maps/ne_50m_admin_1_states_provinces.json",
        "format": {
          "type": "topojson",
          "feature": "ne_50m_admin_1_states_provinces"
        }
      },
      "mark": {
        "type": "geoshape",
        "fill": "#f3f4f6",
        "stroke": "#000000",
        "strokeWidth": 0.5
      }
    },

    {
      "data": {
        "values": [
          { "name": "Western Australia", "lon": 122.0, "lat": -25.3 },
          { "name": "Northern Territory", "lon": 133.5, "lat": -19.5 },
          { "name": "South Australia", "lon": 135.0, "lat": -30.0 },
          { "name": "Queensland", "lon": 144.0, "lat": -23.0 },
          { "name": "New South Wales", "lon": 147.0, "lat": -32.5 },
          { "name": "Victoria", "lon": 144.5, "lat": -37.2 },
          { "name": "Tasmania", "lon": 146.7, "lat": -42.0 }
        ]
      },
      "mark": {
        "type": "text",
        "fontSize": 11,
        "fontWeight": "bold",
        "fill": "#333",
        "baseline": "middle",
        "align": "center",
        "opacity": 0.5
      },
      "encoding": {
        "longitude": { "field": "lon", "type": "quantitative" },
        "latitude": { "field": "lat", "type": "quantitative" },
        "text": { "field": "name" }
      }
    },

    {
      "data": {
        "url": "data/year_and_season.csv",
        "format": { "type": "csv" }
      },
      "transform": [
        { "filter": "datum.Season == season_filter" },
        { "filter": "datum.Year == year_filter" },

        {
          "fold": [
            "MaxTemp",
            "MinTemp",
            "Rainfall",
            "Sunshine",
            "WindGustSpeed"
          ],
          "as": ["Attribute", "Value"]
        },
        { "filter": "datum.Attribute == attribute_select" }
      ],
      "mark": {
        "type": "circle",
        "opacity": 0.8,
        "stroke": "white",
        "strokeWidth": 0.5
      },
      "encoding": {
        "longitude": { "field": "Longitude", "type": "quantitative" },
        "latitude": { "field": "Latitude", "type": "quantitative" },

        "size": {
          "field": "Value",
          "type": "quantitative",
          "scale": {
            "type": "sqrt",
            "zero": false,
            "clamp": true,
            "nice": true,
            "range": [24, 700]
          },
          "legend": {
            "title": null,
            "orient": "bottom",
            "symbolStrokeColor": "white",
            "symbolStrokeWidth": 0.6
          }
        },

        "color": {
          "field": "Value",
          "type": "quantitative",
          "scale": {
            "scheme": { "expr": "attributeColorSchemes[attribute_select]" }
          },
          "legend": {
            "title": null,
            "gradientLength": 160,
            "orient": "bottom"
          }
        },

        "tooltip": [
          { "field": "Attribute", "type": "nominal", "title": "Attribute" },
          { "field": "Value", "type": "quantitative" },
          { "field": "Latitude", "type": "quantitative" },
          { "field": "Longitude", "type": "quantitative" },
          { "field": "State/Territory", "type": "ordinal" }
        ]
      }
    },
    {
      "data": {
        "url": "data/year_and_season.csv",
        "format": { "type": "csv" }
      },
      "transform": [
        { "filter": "datum.Season == season_filter" },
        { "filter": "datum.Year == year_filter" },
        {
          "fold": [
            "MaxTemp",
            "MinTemp",
            "Rainfall",
            "Sunshine",
            "WindGustSpeed"
          ],
          "as": ["Attribute", "Value"]
        },
        { "filter": "datum.Attribute == attribute_select" },
        { "aggregate": [{ "op": "argmax", "field": "Value", "as": "max" }] },

        {
          "calculate": "(toNumber(datum.max.Longitude) - 2) < 112 ? 2 : -2",
          "as": "dx_deg"
        },
        {
          "calculate": "(toNumber(datum.max.Latitude) - 1) < -44 ? 1 : -1",
          "as": "dy_deg"
        },
        {
          "calculate": "toNumber(datum.max.Longitude) + datum.dx_deg",
          "as": "max_lon_label"
        },
        {
          "calculate": "toNumber(datum.max.Latitude)  + datum.dy_deg",
          "as": "max_lat_label"
        },
        {
          "calculate": "'Max: ' + (round(toNumber(datum.max.Value)*10)/10)",
          "as": "max_text"
        },
        {
          "calculate": "datum.dx_deg < 0 ? 'right' : 'left'",
          "as": "text_align"
        },
        {
          "calculate": "datum.dy_deg < 0 ? 'top' : 'bottom'",
          "as": "text_baseline"
        }
      ],
      "layer": [
        {
          "mark": { "type": "rule", "color": "#555", "strokeWidth": 1.5 },
          "encoding": {
            "longitude": { "field": "max.Longitude" },
            "latitude": { "field": "max.Latitude" },
            "longitude2": { "field": "max_lon_label" },
            "latitude2": { "field": "max_lat_label" }
          }
        },

        {
          "mark": {
            "type": "text",
            "fontSize": 15,
            "fontWeight": "bold",
            "fill": "#333",
            "align": { "expr": "datum.text_align" },
            "baseline": { "expr": "datum.text_baseline" },
            "dx": -2,
            "dy": 2,
            "cornerRadius": 4,
            "stroke": "#333",
            "strokeWidth": 0.5
          },
          "encoding": {
            "longitude": { "field": "max_lon_label" },
            "latitude": { "field": "max_lat_label" },
            "text": { "field": "max_text" }
          }
        }
      ]
    },
    {
      "data": {
        "url": "data/year_and_season.csv",
        "format": { "type": "csv" }
      },
      "transform": [
        { "filter": "datum.Season == season_filter" },
        { "filter": "datum.Year == year_filter" },
        {
          "fold": [
            "MaxTemp",
            "MinTemp",
            "Rainfall",
            "Sunshine",
            "WindGustSpeed"
          ],
          "as": ["Attribute", "Value"]
        },
        { "filter": "datum.Attribute == attribute_select" },

        { "aggregate": [{ "op": "argmin", "field": "Value", "as": "min" }] },

        {
          "calculate": "(toNumber(datum.min.Longitude) - 2) < 112 ? 2 : -2",
          "as": "dx_deg"
        },
        {
          "calculate": "(toNumber(datum.min.Latitude) - 1) < -42 ? 1 : -1",
          "as": "dy_deg"
        },

        {
          "calculate": "toNumber(datum.min.Longitude) + datum.dx_deg",
          "as": "min_lon_label"
        },
        {
          "calculate": "toNumber(datum.min.Latitude)  + datum.dy_deg",
          "as": "min_lat_label"
        },

        {
          "calculate": "'Min: ' + (round(toNumber(datum.min.Value)*10)/10)",
          "as": "min_text"
        },

        {
          "calculate": "datum.dx_deg < 0 ? 'right' : 'left'",
          "as": "text_align"
        },
        {
          "calculate": "datum.dy_deg < 0 ? 'top'   : 'bottom'",
          "as": "text_baseline"
        }
      ],
      "layer": [
        {
          "mark": { "type": "rule", "color": "#555", "strokeWidth": 1.5 },
          "encoding": {
            "longitude": { "field": "min.Longitude" },
            "latitude": { "field": "min.Latitude" },
            "longitude2": { "field": "min_lon_label" },
            "latitude2": { "field": "min_lat_label" }
          }
        },
        {
          "mark": {
            "type": "text",
            "fontSize": 15,
            "fontWeight": "bold",
            "fill": "#333",
            "dx": -2,
            "dy": 2
          },
          "encoding": {
            "longitude": { "field": "min_lon_label" },
            "latitude": { "field": "min_lat_label" },
            "text": { "field": "min_text" }
          }
        }
      ]
    }
  ],

  "title": {
    "text": { "expr": "legendTitles[attribute_select]" },
    "anchor": "start"
  },
  "config": {
    "view": { "stroke": null },
    "legend": { "titleFontSize": 12, "labelFontSize": 11 }
  }
}
